#!/bin/bash

# Table of Contents
# -----------------
#   * System-wide
#   * Interface
#   * Prompt String 1
#   * Aliases
#   * Python
#   * User Environment


# ---------------------------------------------------------------------
# System-wide
# ---------------------------------------------------------------------

test -r /etc/bashrc && {
  source /etc/bashrc
}


set +e
set -o ignoreeof
set -o notify

shopt -s cdspell                 >/dev/null 2>&1
shopt -s checkjobs               >/dev/null 2>&1
shopt -s expand_aliases          >/dev/null 2>&1
shopt -s extglob                 >/dev/null 2>&1
shopt -s hostcomplete            >/dev/null 2>&1
shopt -s no_empty_cmd_completion >/dev/null 2>&1

umask 0022

: ${UNAME=$(uname)}


# Paths
# -----

PATH="\
$HOME/local/bin:\
$HOME/.bin:\
/usr/local/bin:\
/usr/local/sbin:\
/usr/bin:\
/usr/sbin:\
/bin:\
/sbin:\
"

MANPATH="\
$HOME/local/share/man:\
/usr/local/share/man:\
/usr/local/man:\
/usr/share/man:\
"


# ---------------------------------------------------------------------
# Interface
# ---------------------------------------------------------------------

case "$-" in
  *i*) INTERACTIVE=true ;;
  *) unset INTERACTIVE ;;
esac

test "$UNAME" = 'Darwin' && {
  MACOS=true
} || {
  unset MACOS
}

test -n "$(command -v vim)" && {
  EDITOR='vim'
  alias vi='vim'
} || {
  EDITOR='vi'
}

GREP_COLOR='0;34'
LESS='-rI'
PAGER='less'

export EDITOR
export PAGER

test -z "$BASH_COMPLETION" && {
  for f in /usr/local/share/bash-completion/bash_completion \
           /usr/local/etc/bash_completion \
           /etc/bash_completion; do
    test -f $f && {
      . $f
      break
    }
  done
}

# Override ``bash_completion`` and disable tilde expansion
_expand() {
  return 0
}

# Reclaim <C-q> and <C-s>
test -n "$INTERACTIVE" && {
  stty -ixon
}

COLORS=$HOME/.config/colors/base16-custom.dark.sh
test -n "$TMUX" -a -f $COLORS && {
  source $COLORS
}

# Find and evaluate ``dircolors`` if exists
_dircolors="$(type -P gdircolors dircolors | head -1)"
test -n "$_dircolors" && {
  eval "$($_dircolors -b ~/.bash/dircolors)"
}


# ---------------------------------------------------------------------
# Prompt String 1
# ---------------------------------------------------------------------

clr() {  # (number, text)
  esc="\033"
  printf "\[${esc}[38;5;${1}m\]${2}\[${esc}[0m\]"
}

export PS1_NO_GIT=0

branch_colon() {
  if test $PS1_NO_GIT -eq 1; then
    return
  fi
  branch=$(git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/')
  if test -n "$branch"; then
    echo ':'
  fi
}

parse_git_branch() {
  if test $PS1_NO_GIT -eq 1; then
    return
  fi
  branch=$(git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/')
  echo $branch
}

git_branch=$(parse_git_branch)
border_color=241
user_color=154
host_color=214
host_text='integra'
pwd_color=228
test "$(whoami)" = 'root' && {
  user_color=220  # Yellow
}

LONG_PS1="\
`clr $border_color  '┌─['                  `\
`clr $user_color    "$(whoami)"            `\
`clr 250            '@'                    `\
`clr $host_color    "$host_text"           `\
`clr $border_color  ':'                    `\
`clr $pwd_color     '\\w'                  `\
`clr $border_color  '\$(branch_colon)'     `\
`clr 207            '\$(parse_git_branch)' `\
`clr $border_color  ']'                    `\
\n\
`clr $border_color  '└['                   `\
`clr 7              '\\$'                  `\
`clr $border_color  ']› '                  `\
"

SHORT_PS1="\
`clr $border_color  '┌─['         `\
`clr $user_color    "$(whoami)"   `\
`clr 250            '@'           `\
`clr $host_color    "$host_text"  `\
`clr $border_color  ':'           `\
`clr $pwd_color     '\\W'         `\
`clr $border_color  ']'           `\
\n\
`clr $border_color  '└['          `\
`clr 7              '\\$'         `\
`clr $border_color  ']› '         `\
"

export PS1="$LONG_PS1"


# ---------------------------------------------------------------------
# Aliases
# ---------------------------------------------------------------------

_cp="$(type -P gcp cp | head -1)"
alias cp="$_cp -i"
if test $(command -v ggrep); then
  alias grep='ggrep -i --color=auto'
else
  alias grep='grep -i --color=auto'
fi

alias ag='ag --color-match "0;35"'

alias mv='mv -i'

# ``ls`` wrangling
# ----------------
export TZ='America/Chicago'

_ls='ls'
test "$(command -v gls)" && {
  _ls='gls'
}
if $_ls --color / >/dev/null 2>&1; then
  GNU_LS=true
else
  BSD_LS=true
fi
if test -n "$GNU_LS"; then
  alias ls="$_ls --color=auto --group-directories-first --time-style +'%b %d %I:%M %p'"
  alias lsld="ls -AhlI'*'"
  alias lsd="ls -AI'*'"
elif test -n "$BSD_LS"; then
  export CLICOLOR=1
  export LSCOLORS='ExGxFxdaCxDaDahbadacec'
  alias ls="$_ls -G"
fi
alias la='ls -A'
alias ll='ls -hl'
alias lla='ls -Ahl'
alias l='ll'


# Mini functions
alias bashrc='source ~/.bashrc'
alias cls="clear && printf '\e[3J'"
alias shortps1='export PS1=$SHORT_PS1'
alias longps1='export PS1="$LONG_PS1"'
alias rm-DS='find . -name .DS_Store -delete -print'
alias hide='chflags hidden'
alias nohide='chflags nohidden'

function mkdirpcd { mkdir -p "$1"; cd "$1"; }
export -f mkdirpcd

alias ..='cd ../'
for i in {2..8}; do
  alias .$i='cd '"$(printf '../%.0s' `seq 1 $i`)"
done

# Platform specific
test -n "$MACOS" && {
  alias top='top -u'
  alias mcopy='pbcopy'
  alias mpaste='pbpaste'
} || {
  alias mcopy='xclip -selection c'
  alias mpaste='xclip -o'
}


# ---------------------------------------------------------------------
# Python
# ---------------------------------------------------------------------

# My module
export PYTHONPATH="$HOME/.ipython/maneyko:$PYTHONPATH"

test -f "$HOME/.pythonrc.py" && {
  PYTHONSTARTUP="$HOME/.pythonrc.py"
}


# ---------------------------------------------------------------------
# User Environment
# ---------------------------------------------------------------------

test -f $HOME/.bash/greeting.bash && {
  source $HOME/.bash/greeting.bash
}

test -f $HOME/.bashrc.local && {
  source $HOME/.bashrc.local
}
